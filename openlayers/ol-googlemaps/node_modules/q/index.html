



<!DOCTYPE html>
<html lang="es" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      <meta http-equiv="x-ua-compatible" content="ie=edge">
      
      
      
      
        <meta name="lang:clipboard.copy" content="Copiar al portapapeles">
      
        <meta name="lang:clipboard.copied" content="Copiado al portapapeles">
      
        <meta name="lang:search.language" content="es">
      
        <meta name="lang:search.pipeline.stopwords" content="True">
      
        <meta name="lang:search.pipeline.trimmer" content="True">
      
        <meta name="lang:search.result.none" content="No se encontraron documentos">
      
        <meta name="lang:search.result.one" content="1 documento encontrado">
      
        <meta name="lang:search.result.other" content="# documentos encontrados">
      
        <meta name="lang:search.tokenizer" content="[\s\-]+">
      
      <link rel="shortcut icon" href="../../../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.0.4, mkdocs-material-3.0.4">
    
    
      
        <title>Curso WebGIS. Mapas libres con Leaflet y OpenLayers</title>
      
    
    
      <link rel="stylesheet" href="../../../../assets/stylesheets/application.451f80e5.css">
      
      
    
    
      <script src="../../../../assets/javascripts/modernizr.1aa3b519.js"></script>
    
    
      
        <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700|Roboto+Mono">
        <style>body,input{font-family:"Roboto","Helvetica Neue",Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono","Courier New",Courier,monospace}</style>
      
    
    <link rel="stylesheet" href="../../../../assets/fonts/material-icons.css">
    
    
  </head>
  
    <body dir="ltr">
  
    <svg class="md-svg">
      <defs>
        
        
          <svg xmlns="http://www.w3.org/2000/svg" width="416" height="448"
    viewBox="0 0 416 448" id="__github">
  <path fill="currentColor" d="M160 304q0 10-3.125 20.5t-10.75 19-18.125
        8.5-18.125-8.5-10.75-19-3.125-20.5 3.125-20.5 10.75-19 18.125-8.5
        18.125 8.5 10.75 19 3.125 20.5zM320 304q0 10-3.125 20.5t-10.75
        19-18.125 8.5-18.125-8.5-10.75-19-3.125-20.5 3.125-20.5 10.75-19
        18.125-8.5 18.125 8.5 10.75 19 3.125 20.5zM360
        304q0-30-17.25-51t-46.75-21q-10.25 0-48.75 5.25-17.75 2.75-39.25
        2.75t-39.25-2.75q-38-5.25-48.75-5.25-29.5 0-46.75 21t-17.25 51q0 22 8
        38.375t20.25 25.75 30.5 15 35 7.375 37.25 1.75h42q20.5 0
        37.25-1.75t35-7.375 30.5-15 20.25-25.75 8-38.375zM416 260q0 51.75-15.25
        82.75-9.5 19.25-26.375 33.25t-35.25 21.5-42.5 11.875-42.875 5.5-41.75
        1.125q-19.5 0-35.5-0.75t-36.875-3.125-38.125-7.5-34.25-12.875-30.25-20.25-21.5-28.75q-15.5-30.75-15.5-82.75
        0-59.25 34-99-6.75-20.5-6.75-42.5 0-29 12.75-54.5 27 0 47.5 9.875t47.25
        30.875q36.75-8.75 77.25-8.75 37 0 70 8 26.25-20.5
        46.75-30.25t47.25-9.75q12.75 25.5 12.75 54.5 0 21.75-6.75 42 34 40 34
        99.5z" />
</svg>
        
      </defs>
    </svg>
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" data-md-component="overlay" for="__drawer"></label>
    
      <a href="../../../../#getting-started" tabindex="1" class="md-skip">
        Saltar a contenido
      </a>
    
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid">
    <div class="md-flex">
      <div class="md-flex__cell md-flex__cell--shrink">
        <a href="../../../.." title="Curso WebGIS. Mapas libres con Leaflet y OpenLayers" class="md-header-nav__button md-logo">
          
            <i class="md-icon"></i>
          
        </a>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <label class="md-icon md-icon--menu md-header-nav__button" for="__drawer"></label>
      </div>
      <div class="md-flex__cell md-flex__cell--stretch">
        <div class="md-flex__ellipsis md-header-nav__title" data-md-component="title">
          
            
              <span class="md-header-nav__topic">
                Curso WebGIS. Mapas libres con Leaflet y OpenLayers
              </span>
              <span class="md-header-nav__topic">
                Home
              </span>
            
          
        </div>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        
          
            <label class="md-icon md-icon--search md-header-nav__button" for="__search"></label>
            
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" placeholder="Búsqueda" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="query" data-md-state="active">
      <label class="md-icon md-search__icon" for="__search"></label>
      <button type="reset" class="md-icon md-search__icon" data-md-component="reset" tabindex="-1">
        &#xE5CD;
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="result">
          <div class="md-search-result__meta">
            Teclee para comenzar búsqueda
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
          
        
      </div>
      
        <div class="md-flex__cell md-flex__cell--shrink">
          <div class="md-header-nav__source">
            


  


  <a href="https://github.com/xeoinquedos/curso-webgis/" title="Ir al repositorio" class="md-source" data-md-source="github">
    
      <div class="md-source__icon">
        <svg viewBox="0 0 24 24" width="24" height="24">
          <use xlink:href="#__github" width="24" height="24"></use>
        </svg>
      </div>
    
    <div class="md-source__repository">
      Curso WebGIS
    </div>
  </a>

          </div>
        </div>
      
    </div>
  </nav>
</header>
    
    <div class="md-container">
      
        
      
      
      <main class="md-main">
        <div class="md-main__inner md-grid" data-md-component="container">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" data-md-level="0">
  <label class="md-nav__title md-nav__title--site" for="__drawer">
    <a href="../../../.." title="Curso WebGIS. Mapas libres con Leaflet y OpenLayers" class="md-nav__button md-logo">
      
        <i class="md-icon"></i>
      
    </a>
    Curso WebGIS. Mapas libres con Leaflet y OpenLayers
  </label>
  
    <div class="md-nav__source">
      


  


  <a href="https://github.com/xeoinquedos/curso-webgis/" title="Ir al repositorio" class="md-source" data-md-source="github">
    
      <div class="md-source__icon">
        <svg viewBox="0 0 24 24" width="24" height="24">
          <use xlink:href="#__github" width="24" height="24"></use>
        </svg>
      </div>
    
    <div class="md-source__repository">
      Curso WebGIS
    </div>
  </a>

    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item">
    <a href="../../../.." title="Home" class="md-nav__link">
      Home
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../../../1_creando_mapa/" title="1. Creando un mapa" class="md-nav__link">
      1. Creando un mapa
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../../../2_capas_base/" title="2. El mapa sin datos. Añadir una capa base" class="md-nav__link">
      2. El mapa sin datos. Añadir una capa base
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../../../3_mis_datos/" title="3. Mas allá de la capa base, añadiendo mis propios datos" class="md-nav__link">
      3. Mas allá de la capa base, añadiendo mis propios datos
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../../../4_wms_wmts/" title="4. Y si los datos son enormes" class="md-nav__link">
      4. Y si los datos son enormes
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../../../5_interactuando_mapa/" title="5. Interactuando con el mapa" class="md-nav__link">
      5. Interactuando con el mapa
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../../../6_osm_y_tilemill/" title="6. Usando OpenStreetMap como fuente de datos, Tilemill. Enlace a GeoTalleres" class="md-nav__link">
      6. Usando OpenStreetMap como fuente de datos, Tilemill. Enlace a GeoTalleres
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../../../7_extra_1_osm_y_umap/" title="7. Extra 1. Un visor rápido con datos vectoriales de OSM usando uMap" class="md-nav__link">
      7. Extra 1. Un visor rápido con datos vectoriales de OSM usando uMap
    </a>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary">
  
  
  
    <label class="md-nav__title" for="__toc">Tabla de contenidos</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#getting-started" title="Getting Started" class="md-nav__link">
    Getting Started
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#resources" title="Resources" class="md-nav__link">
    Resources
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#tutorial" title="Tutorial" class="md-nav__link">
    Tutorial
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#propagation" title="Propagation" class="md-nav__link">
    Propagation
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#chaining" title="Chaining" class="md-nav__link">
    Chaining
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#combination" title="Combination" class="md-nav__link">
    Combination
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sequences" title="Sequences" class="md-nav__link">
    Sequences
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#handling-errors" title="Handling Errors" class="md-nav__link">
    Handling Errors
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#progress-notification" title="Progress Notification" class="md-nav__link">
    Progress Notification
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#the-end" title="The End" class="md-nav__link">
    The End
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#the-beginning" title="The Beginning" class="md-nav__link">
    The Beginning
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#using-qfcall" title="Using Q.fcall" class="md-nav__link">
    Using Q.fcall
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#using-deferreds" title="Using Deferreds" class="md-nav__link">
    Using Deferreds
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#using-qpromise" title="Using Q.Promise" class="md-nav__link">
    Using Q.Promise
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#the-middle" title="The Middle" class="md-nav__link">
    The Middle
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#over-the-wire" title="Over the Wire" class="md-nav__link">
    Over the Wire
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#adapting-node" title="Adapting Node" class="md-nav__link">
    Adapting Node
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#long-stack-traces" title="Long Stack Traces" class="md-nav__link">
    Long Stack Traces
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#tests" title="Tests" class="md-nav__link">
    Tests
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#license" title="License" class="md-nav__link">
    License
  </a>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                  <a href="https://github.com/xeoinquedos/curso-webgis/edit/master/docs/openlayers/ol-googlemaps/node_modules/q/README.md" title="Editar esta página" class="md-icon md-content__icon">&#xE3C9;</a>
                
                
                  <h1>Home</h1>
                
                <p><a href="http://travis-ci.org/kriskowal/q"><img alt="Build Status" src="https://secure.travis-ci.org/kriskowal/q.svg?branch=master" /></a>
<a href="https://cdnjs.com/libraries/q.js"><img alt="CDNJS" src="https://img.shields.io/cdnjs/v/q.js.svg" /></a></p>
<p><a href="http://promises-aplus.github.com/promises-spec">
    <img src="http://kriskowal.github.io/q/q.png" align="right" alt="Q logo" />
</a></p>
<p>If a function cannot return a value or throw an exception without
blocking, it can return a promise instead.  A promise is an object
that represents the return value or the thrown exception that the
function may eventually provide.  A promise can also be used as a
proxy for a <a href="https://github.com/kriskowal/q-connection">remote object</a> to overcome latency.</p>
<p>On the first pass, promises can mitigate the “<a href="http://calculist.org/blog/2011/12/14/why-coroutines-wont-work-on-the-web/">Pyramid of
Doom</a>”: the situation where code marches to the right faster
than it marches forward.</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7
8
9</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="nx">step1</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">value1</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">step2</span><span class="p">(</span><span class="nx">value1</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">value2</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">step3</span><span class="p">(</span><span class="nx">value2</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">value3</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">step4</span><span class="p">(</span><span class="nx">value3</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">value4</span><span class="p">)</span> <span class="p">{</span>
                <span class="c1">// Do something with value4</span>
            <span class="p">});</span>
        <span class="p">});</span>
    <span class="p">});</span>
<span class="p">});</span>
</pre></div>
</td></tr></table>

<p>With a promise library, you can flatten the pyramid.</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="nx">Q</span><span class="p">.</span><span class="nx">fcall</span><span class="p">(</span><span class="nx">promisedStep1</span><span class="p">)</span>
<span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">promisedStep2</span><span class="p">)</span>
<span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">promisedStep3</span><span class="p">)</span>
<span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">promisedStep4</span><span class="p">)</span>
<span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">value4</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// Do something with value4</span>
<span class="p">})</span>
<span class="p">.</span><span class="k">catch</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// Handle any error from all above steps</span>
<span class="p">})</span>
<span class="p">.</span><span class="nx">done</span><span class="p">();</span>
</pre></div>
</td></tr></table>

<p>With this approach, you also get implicit error propagation, just like <code>try</code>,
<code>catch</code>, and <code>finally</code>.  An error in <code>promisedStep1</code> will flow all the way to
the <code>catch</code> function, where it’s caught and handled.  (Here <code>promisedStepN</code> is
a version of <code>stepN</code> that returns a promise.)</p>
<p>The callback approach is called an “inversion of control”.
A function that accepts a callback instead of a return value
is saying, “Don’t call me, I’ll call you.”.  Promises
<a href="http://www.slideshare.net/domenicdenicola/callbacks-promises-and-coroutines-oh-my-the-evolution-of-asynchronicity-in-javascript">un-invert</a> the inversion, cleanly separating the input
arguments from control flow arguments.  This simplifies the
use and creation of API’s, particularly variadic,
rest and spread arguments.</p>
<h2 id="getting-started">Getting Started</h2>
<p>The Q module can be loaded as:</p>
<ul>
<li>A <code>&lt;script&gt;</code> tag (creating a <code>Q</code> global variable): ~2.5 KB minified and
    gzipped.</li>
<li>A Node.js and CommonJS module, available in <a href="https://npmjs.org/">npm</a> as
    the <a href="https://npmjs.org/package/q">q</a> package</li>
<li>An AMD module</li>
<li>A <a href="https://github.com/component/component">component</a> as <code>microjs/q</code></li>
<li>Using <a href="http://bower.io/">bower</a> as <code>q#^1.4.1</code></li>
<li>Using <a href="http://nuget.org/">NuGet</a> as <a href="https://nuget.org/packages/q">Q</a></li>
</ul>
<p>Q can exchange promises with jQuery, Dojo, When.js, WinJS, and more.</p>
<h2 id="resources">Resources</h2>
<p>Our <a href="https://github.com/kriskowal/q/wiki">wiki</a> contains a number of useful resources, including:</p>
<ul>
<li>A method-by-method <a href="https://github.com/kriskowal/q/wiki/API-Reference">Q API reference</a>.</li>
<li>A growing <a href="https://github.com/kriskowal/q/wiki/Examples-Gallery">examples gallery</a>, showing how Q can be used to make
  everything better. From XHR to database access to accessing the Flickr API,
  Q is there for you.</li>
<li>There are many libraries that produce and consume Q promises for everything
  from file system/database access or RPC to templating. For a list of some of
  the more popular ones, see <a href="https://github.com/kriskowal/q/wiki/Libraries">Libraries</a>.</li>
<li>If you want materials that introduce the promise concept generally, and the
  below tutorial isn't doing it for you, check out our collection of
  <a href="https://github.com/kriskowal/q/wiki/General-Promise-Resources">presentations, blog posts, and podcasts</a>.</li>
<li>A guide for those <a href="https://github.com/kriskowal/q/wiki/Coming-from-jQuery">coming from jQuery's <code>$.Deferred</code></a>.</li>
</ul>
<p>We'd also love to have you join the Q-Continuum <a href="https://groups.google.com/forum/#!forum/q-continuum">mailing list</a>.</p>
<h2 id="tutorial">Tutorial</h2>
<p>Promises have a <code>then</code> method, which you can use to get the eventual
return value (fulfillment) or thrown exception (rejection).</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="nx">promiseMeSomething</span><span class="p">()</span>
<span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">value</span><span class="p">)</span> <span class="p">{</span>
<span class="p">},</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">reason</span><span class="p">)</span> <span class="p">{</span>
<span class="p">});</span>
</pre></div>
</td></tr></table>

<p>If <code>promiseMeSomething</code> returns a promise that gets fulfilled later
with a return value, the first function (the fulfillment handler) will be
called with the value.  However, if the <code>promiseMeSomething</code> function
gets rejected later by a thrown exception, the second function (the
rejection handler) will be called with the exception.</p>
<p>Note that resolution of a promise is always asynchronous: that is, the
fulfillment or rejection handler will always be called in the next turn of the
event loop (i.e. <code>process.nextTick</code> in Node). This gives you a nice
guarantee when mentally tracing the flow of your code, namely that
<code>then</code> will always return before either handler is executed.</p>
<p>In this tutorial, we begin with how to consume and work with promises. We'll
talk about how to create them, and thus create functions like
<code>promiseMeSomething</code> that return promises, <a href="#the-beginning">below</a>.</p>
<h3 id="propagation">Propagation</h3>
<p>The <code>then</code> method returns a promise, which in this example, I’m
assigning to <code>outputPromise</code>.</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="kd">var</span> <span class="nx">outputPromise</span> <span class="o">=</span> <span class="nx">getInputPromise</span><span class="p">()</span>
<span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">input</span><span class="p">)</span> <span class="p">{</span>
<span class="p">},</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">reason</span><span class="p">)</span> <span class="p">{</span>
<span class="p">});</span>
</pre></div>
</td></tr></table>

<p>The <code>outputPromise</code> variable becomes a new promise for the return
value of either handler.  Since a function can only either return a
value or throw an exception, only one handler will ever be called and it
will be responsible for resolving <code>outputPromise</code>.</p>
<ul>
<li>
<p>If you return a value in a handler, <code>outputPromise</code> will get
    fulfilled.</p>
</li>
<li>
<p>If you throw an exception in a handler, <code>outputPromise</code> will get
    rejected.</p>
</li>
<li>
<p>If you return a <strong>promise</strong> in a handler, <code>outputPromise</code> will
    “become” that promise.  Being able to become a new promise is useful
    for managing delays, combining results, or recovering from errors.</p>
</li>
</ul>
<p>If the <code>getInputPromise()</code> promise gets rejected and you omit the
rejection handler, the <strong>error</strong> will go to <code>outputPromise</code>:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="kd">var</span> <span class="nx">outputPromise</span> <span class="o">=</span> <span class="nx">getInputPromise</span><span class="p">()</span>
<span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">value</span><span class="p">)</span> <span class="p">{</span>
<span class="p">});</span>
</pre></div>
</td></tr></table>

<p>If the input promise gets fulfilled and you omit the fulfillment handler, the
<strong>value</strong> will go to <code>outputPromise</code>:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="kd">var</span> <span class="nx">outputPromise</span> <span class="o">=</span> <span class="nx">getInputPromise</span><span class="p">()</span>
<span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
<span class="p">});</span>
</pre></div>
</td></tr></table>

<p>Q promises provide a <code>fail</code> shorthand for <code>then</code> when you are only
interested in handling the error:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="kd">var</span> <span class="nx">outputPromise</span> <span class="o">=</span> <span class="nx">getInputPromise</span><span class="p">()</span>
<span class="p">.</span><span class="nx">fail</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
<span class="p">});</span>
</pre></div>
</td></tr></table>

<p>If you are writing JavaScript for modern engines only or using
CoffeeScript, you may use <code>catch</code> instead of <code>fail</code>.</p>
<p>Promises also have a <code>fin</code> function that is like a <code>finally</code> clause.
The final handler gets called, with no arguments, when the promise
returned by <code>getInputPromise()</code> either returns a value or throws an
error.  The value returned or error thrown by <code>getInputPromise()</code>
passes directly to <code>outputPromise</code> unless the final handler fails, and
may be delayed if the final handler returns a promise.</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="kd">var</span> <span class="nx">outputPromise</span> <span class="o">=</span> <span class="nx">getInputPromise</span><span class="p">()</span>
<span class="p">.</span><span class="nx">fin</span><span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="c1">// close files, database connections, stop servers, conclude tests</span>
<span class="p">});</span>
</pre></div>
</td></tr></table>

<ul>
<li>If the handler returns a value, the value is ignored</li>
<li>If the handler throws an error, the error passes to <code>outputPromise</code></li>
<li>If the handler returns a promise, <code>outputPromise</code> gets postponed.  The
    eventual value or error has the same effect as an immediate return
    value or thrown error: a value would be ignored, an error would be
    forwarded.</li>
</ul>
<p>If you are writing JavaScript for modern engines only or using
CoffeeScript, you may use <code>finally</code> instead of <code>fin</code>.</p>
<h3 id="chaining">Chaining</h3>
<p>There are two ways to chain promises.  You can chain promises either
inside or outside handlers.  The next two examples are equivalent.</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="k">return</span> <span class="nx">getUsername</span><span class="p">()</span>
<span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">username</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">getUser</span><span class="p">(</span><span class="nx">username</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">user</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// if we get here without an error,</span>
        <span class="c1">// the value returned here</span>
        <span class="c1">// or the exception thrown here</span>
        <span class="c1">// resolves the promise returned</span>
        <span class="c1">// by the first line</span>
    <span class="p">})</span>
<span class="p">});</span>
</pre></div>
</td></tr></table>

<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="k">return</span> <span class="nx">getUsername</span><span class="p">()</span>
<span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">username</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">getUser</span><span class="p">(</span><span class="nx">username</span><span class="p">);</span>
<span class="p">})</span>
<span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">user</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// if we get here without an error,</span>
    <span class="c1">// the value returned here</span>
    <span class="c1">// or the exception thrown here</span>
    <span class="c1">// resolves the promise returned</span>
    <span class="c1">// by the first line</span>
<span class="p">});</span>
</pre></div>
</td></tr></table>

<p>The only difference is nesting.  It’s useful to nest handlers if you
need to capture multiple input values in your closure.</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="kd">function</span> <span class="nx">authenticate</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">getUsername</span><span class="p">()</span>
    <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">username</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">getUser</span><span class="p">(</span><span class="nx">username</span><span class="p">);</span>
    <span class="p">})</span>
    <span class="c1">// chained because we will not need the user name in the next event</span>
    <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">user</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">getPassword</span><span class="p">()</span>
        <span class="c1">// nested because we need both user and password next</span>
        <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">password</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">user</span><span class="p">.</span><span class="nx">passwordHash</span> <span class="o">!==</span> <span class="nx">hash</span><span class="p">(</span><span class="nx">password</span><span class="p">))</span> <span class="p">{</span>
                <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s2">&quot;Can&#39;t authenticate&quot;</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">});</span>
    <span class="p">});</span>
<span class="p">}</span>
</pre></div>
</td></tr></table>

<h3 id="combination">Combination</h3>
<p>You can turn an array of promises into a promise for the whole,
fulfilled array using <code>all</code>.</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="k">return</span> <span class="nx">Q</span><span class="p">.</span><span class="nx">all</span><span class="p">([</span>
    <span class="nx">eventualAdd</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
    <span class="nx">eventualAdd</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">20</span><span class="p">)</span>
<span class="p">]);</span>
</pre></div>
</td></tr></table>

<p>If you have a promise for an array, you can use <code>spread</code> as a
replacement for <code>then</code>.  The <code>spread</code> function “spreads” the
values over the arguments of the fulfillment handler.  The rejection handler
will get called at the first sign of failure.  That is, whichever of
the received promises fails first gets handled by the rejection handler.</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="kd">function</span> <span class="nx">eventualAdd</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span> <span class="nx">b</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">Q</span><span class="p">.</span><span class="nx">spread</span><span class="p">([</span><span class="nx">a</span><span class="p">,</span> <span class="nx">b</span><span class="p">],</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">a</span><span class="p">,</span> <span class="nx">b</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">a</span> <span class="o">+</span> <span class="nx">b</span><span class="p">;</span>
    <span class="p">})</span>
<span class="p">}</span>
</pre></div>
</td></tr></table>

<p>But <code>spread</code> calls <code>all</code> initially, so you can skip it in chains.</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="k">return</span> <span class="nx">getUsername</span><span class="p">()</span>
<span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">username</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="p">[</span><span class="nx">username</span><span class="p">,</span> <span class="nx">getUser</span><span class="p">(</span><span class="nx">username</span><span class="p">)];</span>
<span class="p">})</span>
<span class="p">.</span><span class="nx">spread</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">username</span><span class="p">,</span> <span class="nx">user</span><span class="p">)</span> <span class="p">{</span>
<span class="p">});</span>
</pre></div>
</td></tr></table>

<p>The <code>all</code> function returns a promise for an array of values.  When this
promise is fulfilled, the array contains the fulfillment values of the original
promises, in the same order as those promises.  If one of the given promises
is rejected, the returned promise is immediately rejected, not waiting for the
rest of the batch.  If you want to wait for all of the promises to either be
fulfilled or rejected, you can use <code>allSettled</code>.</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="nx">Q</span><span class="p">.</span><span class="nx">allSettled</span><span class="p">(</span><span class="nx">promises</span><span class="p">)</span>
<span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">results</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">results</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">result</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">result</span><span class="p">.</span><span class="nx">state</span> <span class="o">===</span> <span class="s2">&quot;fulfilled&quot;</span><span class="p">)</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">value</span> <span class="o">=</span> <span class="nx">result</span><span class="p">.</span><span class="nx">value</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">reason</span> <span class="o">=</span> <span class="nx">result</span><span class="p">.</span><span class="nx">reason</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">});</span>
<span class="p">});</span>
</pre></div>
</td></tr></table>

<p>The <code>any</code> function accepts an array of promises and returns a promise that is
fulfilled by the first given promise to be fulfilled, or rejected if all of the
given promises are rejected.</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="nx">Q</span><span class="p">.</span><span class="nx">any</span><span class="p">(</span><span class="nx">promises</span><span class="p">)</span>
<span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">first</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// Any of the promises was fulfilled.</span>
<span class="p">},</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// All of the promises were rejected.</span>
<span class="p">});</span>
</pre></div>
</td></tr></table>

<h3 id="sequences">Sequences</h3>
<p>If you have a number of promise-producing functions that need
to be run sequentially, you can of course do so manually:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="k">return</span> <span class="nx">foo</span><span class="p">(</span><span class="nx">initialVal</span><span class="p">).</span><span class="nx">then</span><span class="p">(</span><span class="nx">bar</span><span class="p">).</span><span class="nx">then</span><span class="p">(</span><span class="nx">baz</span><span class="p">).</span><span class="nx">then</span><span class="p">(</span><span class="nx">qux</span><span class="p">);</span>
</pre></div>
</td></tr></table>

<p>However, if you want to run a dynamically constructed sequence of
functions, you'll want something like this:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="kd">var</span> <span class="nx">funcs</span> <span class="o">=</span> <span class="p">[</span><span class="nx">foo</span><span class="p">,</span> <span class="nx">bar</span><span class="p">,</span> <span class="nx">baz</span><span class="p">,</span> <span class="nx">qux</span><span class="p">];</span>

<span class="kd">var</span> <span class="nx">result</span> <span class="o">=</span> <span class="nx">Q</span><span class="p">(</span><span class="nx">initialVal</span><span class="p">);</span>
<span class="nx">funcs</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">f</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">result</span> <span class="o">=</span> <span class="nx">result</span><span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">f</span><span class="p">);</span>
<span class="p">});</span>
<span class="k">return</span> <span class="nx">result</span><span class="p">;</span>
</pre></div>
</td></tr></table>

<p>You can make this slightly more compact using <code>reduce</code>:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="k">return</span> <span class="nx">funcs</span><span class="p">.</span><span class="nx">reduce</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">soFar</span><span class="p">,</span> <span class="nx">f</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">soFar</span><span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="nx">f</span><span class="p">);</span>
<span class="p">},</span> <span class="nx">Q</span><span class="p">(</span><span class="nx">initialVal</span><span class="p">));</span>
</pre></div>
</td></tr></table>

<p>Or, you could use the ultra-compact version:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="k">return</span> <span class="nx">funcs</span><span class="p">.</span><span class="nx">reduce</span><span class="p">(</span><span class="nx">Q</span><span class="p">.</span><span class="nx">when</span><span class="p">,</span> <span class="nx">Q</span><span class="p">(</span><span class="nx">initialVal</span><span class="p">));</span>
</pre></div>
</td></tr></table>

<h3 id="handling-errors">Handling Errors</h3>
<p>One sometimes-unintuitive aspect of promises is that if you throw an
exception in the fulfillment handler, it will not be caught by the error
handler.</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="k">return</span> <span class="nx">foo</span><span class="p">()</span>
<span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">value</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s2">&quot;Can&#39;t bar.&quot;</span><span class="p">);</span>
<span class="p">},</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// We only get here if &quot;foo&quot; fails</span>
<span class="p">});</span>
</pre></div>
</td></tr></table>

<p>To see why this is, consider the parallel between promises and
<code>try</code>/<code>catch</code>. We are <code>try</code>-ing to execute <code>foo()</code>: the error
handler represents a <code>catch</code> for <code>foo()</code>, while the fulfillment handler
represents code that happens <em>after</em> the <code>try</code>/<code>catch</code> block.
That code then needs its own <code>try</code>/<code>catch</code> block.</p>
<p>In terms of promises, this means chaining your rejection handler:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="k">return</span> <span class="nx">foo</span><span class="p">()</span>
<span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">value</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s2">&quot;Can&#39;t bar.&quot;</span><span class="p">);</span>
<span class="p">})</span>
<span class="p">.</span><span class="nx">fail</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// We get here with either foo&#39;s error or bar&#39;s error</span>
<span class="p">});</span>
</pre></div>
</td></tr></table>

<h3 id="progress-notification">Progress Notification</h3>
<p>It's possible for promises to report their progress, e.g. for tasks that take a
long time like a file upload. Not all promises will implement progress
notifications, but for those that do, you can consume the progress values using
a third parameter to <code>then</code>:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7
8</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="k">return</span> <span class="nx">uploadFile</span><span class="p">()</span>
<span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="c1">// Success uploading the file</span>
<span class="p">},</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// There was an error, and we get the reason for error</span>
<span class="p">},</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">progress</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// We get notified of the upload&#39;s progress as it is executed</span>
<span class="p">});</span>
</pre></div>
</td></tr></table>

<p>Like <code>fail</code>, Q also provides a shorthand for progress callbacks
called <code>progress</code>:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="k">return</span> <span class="nx">uploadFile</span><span class="p">().</span><span class="nx">progress</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">progress</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// We get notified of the upload&#39;s progress</span>
<span class="p">});</span>
</pre></div>
</td></tr></table>

<h3 id="the-end">The End</h3>
<p>When you get to the end of a chain of promises, you should either
return the last promise or end the chain.  Since handlers catch
errors, it’s an unfortunate pattern that the exceptions can go
unobserved.</p>
<p>So, either return it,</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="k">return</span> <span class="nx">foo</span><span class="p">()</span>
<span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="s2">&quot;bar&quot;</span><span class="p">;</span>
<span class="p">});</span>
</pre></div>
</td></tr></table>

<p>Or, end it.</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="nx">foo</span><span class="p">()</span>
<span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="s2">&quot;bar&quot;</span><span class="p">;</span>
<span class="p">})</span>
<span class="p">.</span><span class="nx">done</span><span class="p">();</span>
</pre></div>
</td></tr></table>

<p>Ending a promise chain makes sure that, if an error doesn’t get
handled before the end, it will get rethrown and reported.</p>
<p>This is a stopgap. We are exploring ways to make unhandled errors
visible without any explicit handling.</p>
<h3 id="the-beginning">The Beginning</h3>
<p>Everything above assumes you get a promise from somewhere else.  This
is the common case.  Every once in a while, you will need to create a
promise from scratch.</p>
<h4 id="using-qfcall">Using <code>Q.fcall</code></h4>
<p>You can create a promise from a value using <code>Q.fcall</code>.  This returns a
promise for 10.</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="k">return</span> <span class="nx">Q</span><span class="p">.</span><span class="nx">fcall</span><span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="mi">10</span><span class="p">;</span>
<span class="p">});</span>
</pre></div>
</td></tr></table>

<p>You can also use <code>fcall</code> to get a promise for an exception.</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="k">return</span> <span class="nx">Q</span><span class="p">.</span><span class="nx">fcall</span><span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s2">&quot;Can&#39;t do it&quot;</span><span class="p">);</span>
<span class="p">});</span>
</pre></div>
</td></tr></table>

<p>As the name implies, <code>fcall</code> can call functions, or even promised
functions.  This uses the <code>eventualAdd</code> function above to add two
numbers.</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="k">return</span> <span class="nx">Q</span><span class="p">.</span><span class="nx">fcall</span><span class="p">(</span><span class="nx">eventualAdd</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
</pre></div>
</td></tr></table>

<h4 id="using-deferreds">Using Deferreds</h4>
<p>If you have to interface with asynchronous functions that are callback-based
instead of promise-based, Q provides a few shortcuts (like <code>Q.nfcall</code> and
friends). But much of the time, the solution will be to use <em>deferreds</em>.</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7
8
9</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="kd">var</span> <span class="nx">deferred</span> <span class="o">=</span> <span class="nx">Q</span><span class="p">.</span><span class="nx">defer</span><span class="p">();</span>
<span class="nx">FS</span><span class="p">.</span><span class="nx">readFile</span><span class="p">(</span><span class="s2">&quot;foo.txt&quot;</span><span class="p">,</span> <span class="s2">&quot;utf-8&quot;</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">error</span><span class="p">,</span> <span class="nx">text</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">deferred</span><span class="p">.</span><span class="nx">reject</span><span class="p">(</span><span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="nx">error</span><span class="p">));</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="nx">deferred</span><span class="p">.</span><span class="nx">resolve</span><span class="p">(</span><span class="nx">text</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">});</span>
<span class="k">return</span> <span class="nx">deferred</span><span class="p">.</span><span class="nx">promise</span><span class="p">;</span>
</pre></div>
</td></tr></table>

<p>Note that a deferred can be resolved with a value or a promise.  The
<code>reject</code> function is a shorthand for resolving with a rejected
promise.</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7
8</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="c1">// this:</span>
<span class="nx">deferred</span><span class="p">.</span><span class="nx">reject</span><span class="p">(</span><span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s2">&quot;Can&#39;t do it&quot;</span><span class="p">));</span>

<span class="c1">// is shorthand for:</span>
<span class="kd">var</span> <span class="nx">rejection</span> <span class="o">=</span> <span class="nx">Q</span><span class="p">.</span><span class="nx">fcall</span><span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s2">&quot;Can&#39;t do it&quot;</span><span class="p">);</span>
<span class="p">});</span>
<span class="nx">deferred</span><span class="p">.</span><span class="nx">resolve</span><span class="p">(</span><span class="nx">rejection</span><span class="p">);</span>
</pre></div>
</td></tr></table>

<p>This is a simplified implementation of <code>Q.delay</code>.</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="kd">function</span> <span class="nx">delay</span><span class="p">(</span><span class="nx">ms</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">deferred</span> <span class="o">=</span> <span class="nx">Q</span><span class="p">.</span><span class="nx">defer</span><span class="p">();</span>
    <span class="nx">setTimeout</span><span class="p">(</span><span class="nx">deferred</span><span class="p">.</span><span class="nx">resolve</span><span class="p">,</span> <span class="nx">ms</span><span class="p">);</span>
    <span class="k">return</span> <span class="nx">deferred</span><span class="p">.</span><span class="nx">promise</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</td></tr></table>

<p>This is a simplified implementation of <code>Q.timeout</code></p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7
8</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="kd">function</span> <span class="nx">timeout</span><span class="p">(</span><span class="nx">promise</span><span class="p">,</span> <span class="nx">ms</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">deferred</span> <span class="o">=</span> <span class="nx">Q</span><span class="p">.</span><span class="nx">defer</span><span class="p">();</span>
    <span class="nx">Q</span><span class="p">.</span><span class="nx">when</span><span class="p">(</span><span class="nx">promise</span><span class="p">,</span> <span class="nx">deferred</span><span class="p">.</span><span class="nx">resolve</span><span class="p">);</span>
    <span class="nx">delay</span><span class="p">(</span><span class="nx">ms</span><span class="p">).</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
        <span class="nx">deferred</span><span class="p">.</span><span class="nx">reject</span><span class="p">(</span><span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s2">&quot;Timed out&quot;</span><span class="p">));</span>
    <span class="p">});</span>
    <span class="k">return</span> <span class="nx">deferred</span><span class="p">.</span><span class="nx">promise</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</td></tr></table>

<p>Finally, you can send a progress notification to the promise with
<code>deferred.notify</code>.</p>
<p>For illustration, this is a wrapper for XML HTTP requests in the browser. Note
that a more <a href="https://github.com/montagejs/mr/blob/71e8df99bb4f0584985accd6f2801ef3015b9763/browser.js#L29-L73">thorough</a> implementation would be in order in practice.</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="kd">function</span> <span class="nx">requestOkText</span><span class="p">(</span><span class="nx">url</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">request</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">XMLHttpRequest</span><span class="p">();</span>
    <span class="kd">var</span> <span class="nx">deferred</span> <span class="o">=</span> <span class="nx">Q</span><span class="p">.</span><span class="nx">defer</span><span class="p">();</span>

    <span class="nx">request</span><span class="p">.</span><span class="nx">open</span><span class="p">(</span><span class="s2">&quot;GET&quot;</span><span class="p">,</span> <span class="nx">url</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>
    <span class="nx">request</span><span class="p">.</span><span class="nx">onload</span> <span class="o">=</span> <span class="nx">onload</span><span class="p">;</span>
    <span class="nx">request</span><span class="p">.</span><span class="nx">onerror</span> <span class="o">=</span> <span class="nx">onerror</span><span class="p">;</span>
    <span class="nx">request</span><span class="p">.</span><span class="nx">onprogress</span> <span class="o">=</span> <span class="nx">onprogress</span><span class="p">;</span>
    <span class="nx">request</span><span class="p">.</span><span class="nx">send</span><span class="p">();</span>

    <span class="kd">function</span> <span class="nx">onload</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">request</span><span class="p">.</span><span class="nx">status</span> <span class="o">===</span> <span class="mi">200</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">deferred</span><span class="p">.</span><span class="nx">resolve</span><span class="p">(</span><span class="nx">request</span><span class="p">.</span><span class="nx">responseText</span><span class="p">);</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="nx">deferred</span><span class="p">.</span><span class="nx">reject</span><span class="p">(</span><span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s2">&quot;Status code was &quot;</span> <span class="o">+</span> <span class="nx">request</span><span class="p">.</span><span class="nx">status</span><span class="p">));</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="kd">function</span> <span class="nx">onerror</span><span class="p">()</span> <span class="p">{</span>
        <span class="nx">deferred</span><span class="p">.</span><span class="nx">reject</span><span class="p">(</span><span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s2">&quot;Can&#39;t XHR &quot;</span> <span class="o">+</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">url</span><span class="p">)));</span>
    <span class="p">}</span>

    <span class="kd">function</span> <span class="nx">onprogress</span><span class="p">(</span><span class="nx">event</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">deferred</span><span class="p">.</span><span class="nx">notify</span><span class="p">(</span><span class="nx">event</span><span class="p">.</span><span class="nx">loaded</span> <span class="o">/</span> <span class="nx">event</span><span class="p">.</span><span class="nx">total</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="nx">deferred</span><span class="p">.</span><span class="nx">promise</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</td></tr></table>

<p>Below is an example of how to use this <code>requestOkText</code> function:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="nx">requestOkText</span><span class="p">(</span><span class="s2">&quot;http://localhost:3000&quot;</span><span class="p">)</span>
<span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">responseText</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// If the HTTP response returns 200 OK, log the response text.</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">responseText</span><span class="p">);</span>
<span class="p">},</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// If there&#39;s an error or a non-200 status code, log the error.</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="nx">error</span><span class="p">);</span>
<span class="p">},</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">progress</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// Log the progress as it comes in.</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;Request progress: &quot;</span> <span class="o">+</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">round</span><span class="p">(</span><span class="nx">progress</span> <span class="o">*</span> <span class="mi">100</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;%&quot;</span><span class="p">);</span>
<span class="p">});</span>
</pre></div>
</td></tr></table>

<h4 id="using-qpromise">Using <code>Q.Promise</code></h4>
<p>This is an alternative promise-creation API that has the same power as
the deferred concept, but without introducing another conceptual entity.</p>
<p>Rewriting the <code>requestOkText</code> example above using <code>Q.Promise</code>:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="kd">function</span> <span class="nx">requestOkText</span><span class="p">(</span><span class="nx">url</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">Q</span><span class="p">.</span><span class="nb">Promise</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">resolve</span><span class="p">,</span> <span class="nx">reject</span><span class="p">,</span> <span class="nx">notify</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">request</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">XMLHttpRequest</span><span class="p">();</span>

        <span class="nx">request</span><span class="p">.</span><span class="nx">open</span><span class="p">(</span><span class="s2">&quot;GET&quot;</span><span class="p">,</span> <span class="nx">url</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>
        <span class="nx">request</span><span class="p">.</span><span class="nx">onload</span> <span class="o">=</span> <span class="nx">onload</span><span class="p">;</span>
        <span class="nx">request</span><span class="p">.</span><span class="nx">onerror</span> <span class="o">=</span> <span class="nx">onerror</span><span class="p">;</span>
        <span class="nx">request</span><span class="p">.</span><span class="nx">onprogress</span> <span class="o">=</span> <span class="nx">onprogress</span><span class="p">;</span>
        <span class="nx">request</span><span class="p">.</span><span class="nx">send</span><span class="p">();</span>

        <span class="kd">function</span> <span class="nx">onload</span><span class="p">()</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">request</span><span class="p">.</span><span class="nx">status</span> <span class="o">===</span> <span class="mi">200</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">resolve</span><span class="p">(</span><span class="nx">request</span><span class="p">.</span><span class="nx">responseText</span><span class="p">);</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="nx">reject</span><span class="p">(</span><span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s2">&quot;Status code was &quot;</span> <span class="o">+</span> <span class="nx">request</span><span class="p">.</span><span class="nx">status</span><span class="p">));</span>
            <span class="p">}</span>
        <span class="p">}</span>

        <span class="kd">function</span> <span class="nx">onerror</span><span class="p">()</span> <span class="p">{</span>
            <span class="nx">reject</span><span class="p">(</span><span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s2">&quot;Can&#39;t XHR &quot;</span> <span class="o">+</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">url</span><span class="p">)));</span>
        <span class="p">}</span>

        <span class="kd">function</span> <span class="nx">onprogress</span><span class="p">(</span><span class="nx">event</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">notify</span><span class="p">(</span><span class="nx">event</span><span class="p">.</span><span class="nx">loaded</span> <span class="o">/</span> <span class="nx">event</span><span class="p">.</span><span class="nx">total</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">});</span>
<span class="p">}</span>
</pre></div>
</td></tr></table>

<p>If <code>requestOkText</code> were to throw an exception, the returned promise would be
rejected with that thrown exception as the rejection reason.</p>
<h3 id="the-middle">The Middle</h3>
<p>If you are using a function that may return a promise, but just might
return a value if it doesn’t need to defer, you can use the “static”
methods of the Q library.</p>
<p>The <code>when</code> function is the static equivalent for <code>then</code>.</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="k">return</span> <span class="nx">Q</span><span class="p">.</span><span class="nx">when</span><span class="p">(</span><span class="nx">valueOrPromise</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">value</span><span class="p">)</span> <span class="p">{</span>
<span class="p">},</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
<span class="p">});</span>
</pre></div>
</td></tr></table>

<p>All of the other methods on a promise have static analogs with the
same name.</p>
<p>The following are equivalent:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="k">return</span> <span class="nx">Q</span><span class="p">.</span><span class="nx">all</span><span class="p">([</span><span class="nx">a</span><span class="p">,</span> <span class="nx">b</span><span class="p">]);</span>
</pre></div>
</td></tr></table>

<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="k">return</span> <span class="nx">Q</span><span class="p">.</span><span class="nx">fcall</span><span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="p">[</span><span class="nx">a</span><span class="p">,</span> <span class="nx">b</span><span class="p">];</span>
<span class="p">})</span>
<span class="p">.</span><span class="nx">all</span><span class="p">();</span>
</pre></div>
</td></tr></table>

<p>When working with promises provided by other libraries, you should
convert it to a Q promise.  Not all promise libraries make the same
guarantees as Q and certainly don’t provide all of the same methods.
Most libraries only provide a partially functional <code>then</code> method.
This thankfully is all we need to turn them into vibrant Q promises.</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="k">return</span> <span class="nx">Q</span><span class="p">(</span><span class="nx">$</span><span class="p">.</span><span class="nx">ajax</span><span class="p">(...))</span>
<span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
<span class="p">});</span>
</pre></div>
</td></tr></table>

<p>If there is any chance that the promise you receive is not a Q promise
as provided by your library, you should wrap it using a Q function.
You can even use <code>Q.invoke</code> as a shorthand.</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="k">return</span> <span class="nx">Q</span><span class="p">.</span><span class="nx">invoke</span><span class="p">(</span><span class="nx">$</span><span class="p">,</span> <span class="s1">&#39;ajax&#39;</span><span class="p">,</span> <span class="p">...)</span>
<span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
<span class="p">});</span>
</pre></div>
</td></tr></table>

<h3 id="over-the-wire">Over the Wire</h3>
<p>A promise can serve as a proxy for another object, even a remote
object.  There are methods that allow you to optimistically manipulate
properties or call functions.  All of these interactions return
promises, so they can be chained.</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7
8
9</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>direct manipulation         using a promise as a proxy
--------------------------  -------------------------------
value.foo                   promise.get(&quot;foo&quot;)
value.foo = value           promise.put(&quot;foo&quot;, value)
delete value.foo            promise.del(&quot;foo&quot;)
value.foo(...args)          promise.post(&quot;foo&quot;, [args])
value.foo(...args)          promise.invoke(&quot;foo&quot;, ...args)
value(...args)              promise.fapply([args])
value(...args)              promise.fcall(...args)
</pre></div>
</td></tr></table>

<p>If the promise is a proxy for a remote object, you can shave
round-trips by using these functions instead of <code>then</code>.  To take
advantage of promises for remote objects, check out <a href="https://github.com/kriskowal/q-connection">Q-Connection</a>.</p>
<p>Even in the case of non-remote objects, these methods can be used as
shorthand for particularly-simple fulfillment handlers. For example, you
can replace</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="k">return</span> <span class="nx">Q</span><span class="p">.</span><span class="nx">fcall</span><span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="p">[{</span> <span class="nx">foo</span><span class="o">:</span> <span class="s2">&quot;bar&quot;</span> <span class="p">},</span> <span class="p">{</span> <span class="nx">foo</span><span class="o">:</span> <span class="s2">&quot;baz&quot;</span> <span class="p">}];</span>
<span class="p">})</span>
<span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">value</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">value</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">foo</span><span class="p">;</span>
<span class="p">});</span>
</pre></div>
</td></tr></table>

<p>with</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="k">return</span> <span class="nx">Q</span><span class="p">.</span><span class="nx">fcall</span><span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="k">return</span> <span class="p">[{</span> <span class="nx">foo</span><span class="o">:</span> <span class="s2">&quot;bar&quot;</span> <span class="p">},</span> <span class="p">{</span> <span class="nx">foo</span><span class="o">:</span> <span class="s2">&quot;baz&quot;</span> <span class="p">}];</span>
<span class="p">})</span>
<span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;foo&quot;</span><span class="p">);</span>
</pre></div>
</td></tr></table>

<h3 id="adapting-node">Adapting Node</h3>
<p>If you're working with functions that make use of the Node.js callback pattern,
where callbacks are in the form of <code>function(err, result)</code>, Q provides a few
useful utility functions for converting between them. The most straightforward
are probably <code>Q.nfcall</code> and <code>Q.nfapply</code> ("Node function call/apply") for calling
Node.js-style functions and getting back a promise:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="k">return</span> <span class="nx">Q</span><span class="p">.</span><span class="nx">nfcall</span><span class="p">(</span><span class="nx">FS</span><span class="p">.</span><span class="nx">readFile</span><span class="p">,</span> <span class="s2">&quot;foo.txt&quot;</span><span class="p">,</span> <span class="s2">&quot;utf-8&quot;</span><span class="p">);</span>
<span class="k">return</span> <span class="nx">Q</span><span class="p">.</span><span class="nx">nfapply</span><span class="p">(</span><span class="nx">FS</span><span class="p">.</span><span class="nx">readFile</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;foo.txt&quot;</span><span class="p">,</span> <span class="s2">&quot;utf-8&quot;</span><span class="p">]);</span>
</pre></div>
</td></tr></table>

<p>If you are working with methods, instead of simple functions, you can easily
run in to the usual problems where passing a method to another function—like
<code>Q.nfcall</code>—"un-binds" the method from its owner. To avoid this, you can either
use <code>Function.prototype.bind</code> or some nice shortcut methods we provide:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="k">return</span> <span class="nx">Q</span><span class="p">.</span><span class="nx">ninvoke</span><span class="p">(</span><span class="nx">redisClient</span><span class="p">,</span> <span class="s2">&quot;get&quot;</span><span class="p">,</span> <span class="s2">&quot;user:1:id&quot;</span><span class="p">);</span>
<span class="k">return</span> <span class="nx">Q</span><span class="p">.</span><span class="nx">npost</span><span class="p">(</span><span class="nx">redisClient</span><span class="p">,</span> <span class="s2">&quot;get&quot;</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;user:1:id&quot;</span><span class="p">]);</span>
</pre></div>
</td></tr></table>

<p>You can also create reusable wrappers with <code>Q.denodeify</code> or <code>Q.nbind</code>:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="kd">var</span> <span class="nx">readFile</span> <span class="o">=</span> <span class="nx">Q</span><span class="p">.</span><span class="nx">denodeify</span><span class="p">(</span><span class="nx">FS</span><span class="p">.</span><span class="nx">readFile</span><span class="p">);</span>
<span class="k">return</span> <span class="nx">readFile</span><span class="p">(</span><span class="s2">&quot;foo.txt&quot;</span><span class="p">,</span> <span class="s2">&quot;utf-8&quot;</span><span class="p">);</span>

<span class="kd">var</span> <span class="nx">redisClientGet</span> <span class="o">=</span> <span class="nx">Q</span><span class="p">.</span><span class="nx">nbind</span><span class="p">(</span><span class="nx">redisClient</span><span class="p">.</span><span class="nx">get</span><span class="p">,</span> <span class="nx">redisClient</span><span class="p">);</span>
<span class="k">return</span> <span class="nx">redisClientGet</span><span class="p">(</span><span class="s2">&quot;user:1:id&quot;</span><span class="p">);</span>
</pre></div>
</td></tr></table>

<p>Finally, if you're working with raw deferred objects, there is a
<code>makeNodeResolver</code> method on deferreds that can be handy:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="kd">var</span> <span class="nx">deferred</span> <span class="o">=</span> <span class="nx">Q</span><span class="p">.</span><span class="nx">defer</span><span class="p">();</span>
<span class="nx">FS</span><span class="p">.</span><span class="nx">readFile</span><span class="p">(</span><span class="s2">&quot;foo.txt&quot;</span><span class="p">,</span> <span class="s2">&quot;utf-8&quot;</span><span class="p">,</span> <span class="nx">deferred</span><span class="p">.</span><span class="nx">makeNodeResolver</span><span class="p">());</span>
<span class="k">return</span> <span class="nx">deferred</span><span class="p">.</span><span class="nx">promise</span><span class="p">;</span>
</pre></div>
</td></tr></table>

<h3 id="long-stack-traces">Long Stack Traces</h3>
<p>Q comes with optional support for “long stack traces,” wherein the <code>stack</code>
property of <code>Error</code> rejection reasons is rewritten to be traced along
asynchronous jumps instead of stopping at the most recent one. As an example:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="kd">function</span> <span class="nx">theDepthsOfMyProgram</span><span class="p">()</span> <span class="p">{</span>
  <span class="nx">Q</span><span class="p">.</span><span class="nx">delay</span><span class="p">(</span><span class="mi">100</span><span class="p">).</span><span class="nx">done</span><span class="p">(</span><span class="kd">function</span> <span class="nx">explode</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s2">&quot;boo!&quot;</span><span class="p">);</span>
  <span class="p">});</span>
<span class="p">}</span>

<span class="nx">theDepthsOfMyProgram</span><span class="p">();</span>
</pre></div>
</td></tr></table>

<p>usually would give a rather unhelpful stack trace looking something like</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="n">Error</span><span class="o">:</span> <span class="n">boo</span><span class="o">!</span>
    <span class="n">at</span> <span class="n">explode</span> <span class="o">(/</span><span class="n">path</span><span class="sr">/to/</span><span class="n">test</span><span class="o">.</span><span class="na">js</span><span class="o">:</span><span class="mi">3</span><span class="o">:</span><span class="mi">11</span><span class="o">)</span>
    <span class="n">at</span> <span class="n">_fulfilled</span> <span class="o">(/</span><span class="n">path</span><span class="sr">/to/</span><span class="n">test</span><span class="o">.</span><span class="na">js</span><span class="o">:</span><span class="n">q</span><span class="o">:</span><span class="mi">54</span><span class="o">)</span>
    <span class="n">at</span> <span class="n">resolvedValue</span><span class="o">.</span><span class="na">promiseDispatch</span><span class="o">.</span><span class="na">done</span> <span class="o">(/</span><span class="n">path</span><span class="sr">/to/</span><span class="n">q</span><span class="o">.</span><span class="na">js</span><span class="o">:</span><span class="mi">823</span><span class="o">:</span><span class="mi">30</span><span class="o">)</span>
    <span class="n">at</span> <span class="n">makePromise</span><span class="o">.</span><span class="na">promise</span><span class="o">.</span><span class="na">promiseDispatch</span> <span class="o">(/</span><span class="n">path</span><span class="sr">/to/</span><span class="n">q</span><span class="o">.</span><span class="na">js</span><span class="o">:</span><span class="mi">496</span><span class="o">:</span><span class="mi">13</span><span class="o">)</span>
    <span class="n">at</span> <span class="n">pending</span> <span class="o">(/</span><span class="n">path</span><span class="sr">/to/</span><span class="n">q</span><span class="o">.</span><span class="na">js</span><span class="o">:</span><span class="mi">397</span><span class="o">:</span><span class="mi">39</span><span class="o">)</span>
    <span class="n">at</span> <span class="n">process</span><span class="o">.</span><span class="na">startup</span><span class="o">.</span><span class="na">processNextTick</span><span class="o">.</span><span class="na">process</span><span class="o">.</span><span class="na">_tickCallback</span> <span class="o">(</span><span class="n">node</span><span class="o">.</span><span class="na">js</span><span class="o">:</span><span class="mi">244</span><span class="o">:</span><span class="mi">9</span><span class="o">)</span>
</pre></div>
</td></tr></table>

<p>But, if you turn this feature on by setting</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="nx">Q</span><span class="p">.</span><span class="nx">longStackSupport</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
</pre></div>
</td></tr></table>

<p>then the above code gives a nice stack trace to the tune of</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="n">Error</span><span class="o">:</span> <span class="n">boo</span><span class="o">!</span>
    <span class="n">at</span> <span class="n">explode</span> <span class="o">(/</span><span class="n">path</span><span class="sr">/to/</span><span class="n">test</span><span class="o">.</span><span class="na">js</span><span class="o">:</span><span class="mi">3</span><span class="o">:</span><span class="mi">11</span><span class="o">)</span>
<span class="n">From</span> <span class="n">previous</span> <span class="n">event</span><span class="o">:</span>
    <span class="n">at</span> <span class="n">theDepthsOfMyProgram</span> <span class="o">(/</span><span class="n">path</span><span class="sr">/to/</span><span class="n">test</span><span class="o">.</span><span class="na">js</span><span class="o">:</span><span class="mi">2</span><span class="o">:</span><span class="mi">16</span><span class="o">)</span>
    <span class="n">at</span> <span class="n">Object</span><span class="o">.&lt;</span><span class="n">anonymous</span><span class="o">&gt;</span> <span class="o">(/</span><span class="n">path</span><span class="sr">/to/</span><span class="n">test</span><span class="o">.</span><span class="na">js</span><span class="o">:</span><span class="mi">7</span><span class="o">:</span><span class="mi">1</span><span class="o">)</span>
</pre></div>
</td></tr></table>

<p>Note how you can see the function that triggered the async operation in the
stack trace! This is very helpful for debugging, as otherwise you end up getting
only the first line, plus a bunch of Q internals, with no sign of where the
operation started.</p>
<p>In node.js, this feature can also be enabled through the Q_DEBUG environment
variable:</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>Q_DEBUG=1 node server.js
</pre></div>
</td></tr></table>

<p>This will enable long stack support in every instance of Q.</p>
<p>This feature does come with somewhat-serious performance and memory overhead,
however. If you're working with lots of promises, or trying to scale a server
to many users, you should probably keep it off. But in development, go for it!</p>
<h2 id="tests">Tests</h2>
<p>You can view the results of the Q test suite <a href="https://rawgithub.com/kriskowal/q/v1/spec/q-spec.html">in your browser</a>!</p>
<h2 id="license">License</h2>
<p>Copyright 2009–2017 Kristopher Michael Kowal and contributors
MIT License (enclosed)</p>
                
                  
                
              
              
                


              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
        powered by
        <a href="https://www.mkdocs.org">MkDocs</a>
        and
        <a href="https://squidfunk.github.io/mkdocs-material/">
          Material for MkDocs</a>
      </div>
      
        
      
    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../../../../assets/javascripts/application.583bbe55.js"></script>
      
        
        
          
          <script src="../../../../assets/javascripts/lunr/lunr.stemmer.support.js"></script>
          
            
              
              
                <script src="../../../../assets/javascripts/lunr/lunr.es.js"></script>
              
            
          
          
        
      
      <script>app.initialize({version:"1.0.4",url:{base:"../../../.."}})</script>
      
    
    
      
    
  </body>
</html>
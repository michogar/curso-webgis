{"version":3,"file":"VectorSource.js","sources":["../../../src/olgm/herald/VectorSource.js"],"sourcesContent":["/**\n * @module olgm/herald/VectorSource\n */\nimport {unlistenAllByKey} from '../util.js';\nimport {createStyle} from '../gm.js';\nimport SourceHerald from './Source.js';\nimport VectorFeatureHerald from './VectorFeature.js';\n\n/**\n * @typedef {Object} LayerCache\n * @property {google.maps.Data} data\n * @property {module:olgm/herald/VectorFeature} herald\n * @property {module:ol/layer/Vector} layer\n * @property {Array<module:ol/events~EventsKey|Array<module:ol/events~EventsKey>>} listenerKeys\n * @property {number} opacity\n */\n\nclass VectorSourceHerald extends SourceHerald {\n  /**\n   * Listen to a Vector layer\n   * @param {module:ol/PluggableMap} ol3map openlayers map\n   * @param {google.maps.Map} gmap google maps map\n   * @param {module:olgm/gm/MapIcon~Options} mapIconOptions map icon options\n   */\n  constructor(ol3map, gmap, mapIconOptions) {\n    super(ol3map, gmap);\n\n    /**\n    * @type {Array<module:olgm/herald/VectorSource~LayerCache>}\n    * @private\n    */\n    this.cache_ = [];\n\n    /**\n    * @type {Array<module:ol/layer/Vector>}\n    * @private\n    */\n    this.layers_ = [];\n\n    /**\n     * @type {module:olgm/gm/MapIcon~Options}\n     * @private\n     */\n    this.mapIconOptions_ = mapIconOptions;\n  }\n\n\n  /**\n   * @param {module:ol/layer/Base} layer layer to watch\n   * @override\n   */\n  watchLayer(layer) {\n    const vectorLayer = /** @type {module:ol/layer/Vector} */ (layer);\n\n    // Source required\n    const source = vectorLayer.getSource();\n    if (!source) {\n      return;\n    }\n\n    this.layers_.push(vectorLayer);\n\n    // Data\n    const data = new google.maps.Data({\n      'map': this.gmap\n    });\n\n    // Style\n    const gmStyle = createStyle(vectorLayer, this.mapIconOptions_);\n    if (gmStyle) {\n      data.setStyle(gmStyle);\n    }\n\n    // herald\n    const herald = new VectorFeatureHerald(\n      this.ol3map, this.gmap, source, data, this.mapIconOptions_);\n\n    // opacity\n    const opacity = vectorLayer.getOpacity();\n\n    const cacheItem = /** {@type module:olgm/herald/VectorSource~LayerCache} */ ({\n      data: data,\n      herald: herald,\n      layer: vectorLayer,\n      listenerKeys: [],\n      opacity: opacity\n    });\n\n    cacheItem.listenerKeys.push(vectorLayer.on('change:visible',\n      () => this.handleVisibleChange_(cacheItem)));\n\n    const view = this.ol3map.getView();\n    cacheItem.listenerKeys.push(view.on('change:resolution',\n      () => this.handleResolutionChange_(cacheItem)));\n\n\n    this.activateCacheItem_(cacheItem);\n\n    this.cache_.push(cacheItem);\n  }\n\n\n  /**\n   * Unwatch the vector layer\n   * @param {module:ol/layer/Base} layer layer to unwatch\n   * @override\n   */\n  unwatchLayer(layer) {\n    const vectorLayer = /** @type {module:ol/layer/Vector} */ (layer);\n\n    const index = this.layers_.indexOf(vectorLayer);\n    if (index !== -1) {\n      this.layers_.splice(index, 1);\n\n      const cacheItem = this.cache_[index];\n      unlistenAllByKey(cacheItem.listenerKeys);\n\n      // data - unset\n      cacheItem.data.setMap(null);\n\n      // herald\n      cacheItem.herald.deactivate();\n\n      // opacity\n      vectorLayer.setOpacity(cacheItem.opacity);\n\n      this.cache_.splice(index, 1);\n    }\n\n  }\n\n\n  /**\n   * Activate all cache items\n   * @api\n   * @override\n   */\n  activate() {\n    super.activate();\n    this.cache_.forEach(this.activateCacheItem_, this);\n  }\n\n\n  /**\n   * Activates an image WMS layer cache item.\n   * @param {module:olgm/herald/VectorSource~LayerCache} cacheItem cacheItem to activate\n   * @private\n   */\n  activateCacheItem_(cacheItem) {\n    const layer = cacheItem.layer;\n    const visible = layer.getVisible();\n    if (visible && this.googleMapsIsActive) {\n      cacheItem.herald.activate();\n      cacheItem.layer.setOpacity(0);\n    }\n  }\n\n\n  /**\n   * Deactivate all cache items\n   * @api\n   * @override\n   */\n  deactivate() {\n    super.deactivate();\n    this.cache_.forEach(this.deactivateCacheItem_, this);\n  }\n\n\n  /**\n   * Deactivates a Tile WMS layer cache item.\n   * @param {module:olgm/herald/VectorSource~LayerCache} cacheItem cacheItem to\n   * deactivate\n   * @private\n   */\n  deactivateCacheItem_(cacheItem) {\n    cacheItem.herald.deactivate();\n    cacheItem.layer.setOpacity(cacheItem.opacity);\n  }\n\n\n  handleResolutionChange_(cacheItem) {\n    const layer = cacheItem.layer;\n\n    const minResolution = layer.getMinResolution();\n    const maxResolution = layer.getMaxResolution();\n    const currentResolution = this.ol3map.getView().getResolution();\n    if (currentResolution < minResolution || currentResolution > maxResolution) {\n      cacheItem.herald.setVisible(false);\n    } else {\n      cacheItem.herald.setVisible(true);\n    }\n  }\n\n\n  /**\n   * Deal with the google WMS layer when we enable or disable the OL3 WMS layer\n   * @param {module:olgm/herald/VectorSource~LayerCache} cacheItem cacheItem for the\n   * watched layer\n   * @private\n   */\n  handleVisibleChange_(cacheItem) {\n    const layer = cacheItem.layer;\n    const visible = layer.getVisible();\n    if (visible) {\n      this.activateCacheItem_(cacheItem);\n    } else {\n      this.deactivateCacheItem_(cacheItem);\n    }\n  }\n}\n\n\nexport default VectorSourceHerald;\n"],"names":["super","const","this"],"mappings":"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"}
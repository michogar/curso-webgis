



<!DOCTYPE html>
<html lang="es" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      <meta http-equiv="x-ua-compatible" content="ie=edge">
      
      
      
      
        <meta name="lang:clipboard.copy" content="Copiar al portapapeles">
      
        <meta name="lang:clipboard.copied" content="Copiado al portapapeles">
      
        <meta name="lang:search.language" content="es">
      
        <meta name="lang:search.pipeline.stopwords" content="True">
      
        <meta name="lang:search.pipeline.trimmer" content="True">
      
        <meta name="lang:search.result.none" content="No se encontraron documentos">
      
        <meta name="lang:search.result.one" content="1 documento encontrado">
      
        <meta name="lang:search.result.other" content="# documentos encontrados">
      
        <meta name="lang:search.tokenizer" content="[\s\-]+">
      
      <link rel="shortcut icon" href="../../../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.0.4, mkdocs-material-3.0.4">
    
    
      
        <title>Curso WebGIS. Mapas libres con Leaflet y OpenLayers</title>
      
    
    
      <link rel="stylesheet" href="../../../../assets/stylesheets/application.451f80e5.css">
      
      
    
    
      <script src="../../../../assets/javascripts/modernizr.1aa3b519.js"></script>
    
    
      
        <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700|Roboto+Mono">
        <style>body,input{font-family:"Roboto","Helvetica Neue",Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono","Courier New",Courier,monospace}</style>
      
    
    <link rel="stylesheet" href="../../../../assets/fonts/material-icons.css">
    
    
  </head>
  
    <body dir="ltr">
  
    <svg class="md-svg">
      <defs>
        
        
          <svg xmlns="http://www.w3.org/2000/svg" width="416" height="448"
    viewBox="0 0 416 448" id="__github">
  <path fill="currentColor" d="M160 304q0 10-3.125 20.5t-10.75 19-18.125
        8.5-18.125-8.5-10.75-19-3.125-20.5 3.125-20.5 10.75-19 18.125-8.5
        18.125 8.5 10.75 19 3.125 20.5zM320 304q0 10-3.125 20.5t-10.75
        19-18.125 8.5-18.125-8.5-10.75-19-3.125-20.5 3.125-20.5 10.75-19
        18.125-8.5 18.125 8.5 10.75 19 3.125 20.5zM360
        304q0-30-17.25-51t-46.75-21q-10.25 0-48.75 5.25-17.75 2.75-39.25
        2.75t-39.25-2.75q-38-5.25-48.75-5.25-29.5 0-46.75 21t-17.25 51q0 22 8
        38.375t20.25 25.75 30.5 15 35 7.375 37.25 1.75h42q20.5 0
        37.25-1.75t35-7.375 30.5-15 20.25-25.75 8-38.375zM416 260q0 51.75-15.25
        82.75-9.5 19.25-26.375 33.25t-35.25 21.5-42.5 11.875-42.875 5.5-41.75
        1.125q-19.5 0-35.5-0.75t-36.875-3.125-38.125-7.5-34.25-12.875-30.25-20.25-21.5-28.75q-15.5-30.75-15.5-82.75
        0-59.25 34-99-6.75-20.5-6.75-42.5 0-29 12.75-54.5 27 0 47.5 9.875t47.25
        30.875q36.75-8.75 77.25-8.75 37 0 70 8 26.25-20.5
        46.75-30.25t47.25-9.75q12.75 25.5 12.75 54.5 0 21.75-6.75 42 34 40 34
        99.5z" />
</svg>
        
      </defs>
    </svg>
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" data-md-component="overlay" for="__drawer"></label>
    
      <a href="../../../../#ws-a-nodejs-websocket-library" tabindex="1" class="md-skip">
        Saltar a contenido
      </a>
    
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid">
    <div class="md-flex">
      <div class="md-flex__cell md-flex__cell--shrink">
        <a href="../../../.." title="Curso WebGIS. Mapas libres con Leaflet y OpenLayers" class="md-header-nav__button md-logo">
          
            <i class="md-icon"></i>
          
        </a>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <label class="md-icon md-icon--menu md-header-nav__button" for="__drawer"></label>
      </div>
      <div class="md-flex__cell md-flex__cell--stretch">
        <div class="md-flex__ellipsis md-header-nav__title" data-md-component="title">
          
            
              <span class="md-header-nav__topic">
                Curso WebGIS. Mapas libres con Leaflet y OpenLayers
              </span>
              <span class="md-header-nav__topic">
                ws: a Node.js WebSocket library
              </span>
            
          
        </div>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        
          
            <label class="md-icon md-icon--search md-header-nav__button" for="__search"></label>
            
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" placeholder="Búsqueda" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="query" data-md-state="active">
      <label class="md-icon md-search__icon" for="__search"></label>
      <button type="reset" class="md-icon md-search__icon" data-md-component="reset" tabindex="-1">
        &#xE5CD;
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="result">
          <div class="md-search-result__meta">
            Teclee para comenzar búsqueda
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
          
        
      </div>
      
        <div class="md-flex__cell md-flex__cell--shrink">
          <div class="md-header-nav__source">
            


  


  <a href="https://github.com/xeoinquedos/curso-webgis/" title="Ir al repositorio" class="md-source" data-md-source="github">
    
      <div class="md-source__icon">
        <svg viewBox="0 0 24 24" width="24" height="24">
          <use xlink:href="#__github" width="24" height="24"></use>
        </svg>
      </div>
    
    <div class="md-source__repository">
      Curso WebGIS
    </div>
  </a>

          </div>
        </div>
      
    </div>
  </nav>
</header>
    
    <div class="md-container">
      
        
      
      
      <main class="md-main">
        <div class="md-main__inner md-grid" data-md-component="container">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" data-md-level="0">
  <label class="md-nav__title md-nav__title--site" for="__drawer">
    <a href="../../../.." title="Curso WebGIS. Mapas libres con Leaflet y OpenLayers" class="md-nav__button md-logo">
      
        <i class="md-icon"></i>
      
    </a>
    Curso WebGIS. Mapas libres con Leaflet y OpenLayers
  </label>
  
    <div class="md-nav__source">
      


  


  <a href="https://github.com/xeoinquedos/curso-webgis/" title="Ir al repositorio" class="md-source" data-md-source="github">
    
      <div class="md-source__icon">
        <svg viewBox="0 0 24 24" width="24" height="24">
          <use xlink:href="#__github" width="24" height="24"></use>
        </svg>
      </div>
    
    <div class="md-source__repository">
      Curso WebGIS
    </div>
  </a>

    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item">
    <a href="../../../.." title="Home" class="md-nav__link">
      Home
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../../../1_creando_mapa/" title="1. Creando un mapa" class="md-nav__link">
      1. Creando un mapa
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../../../2_capas_base/" title="2. El mapa sin datos. Añadir una capa base" class="md-nav__link">
      2. El mapa sin datos. Añadir una capa base
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../../../3_mis_datos/" title="3. Mas allá de la capa base, añadiendo mis propios datos" class="md-nav__link">
      3. Mas allá de la capa base, añadiendo mis propios datos
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../../../4_wms_wmts/" title="4. Y si los datos son enormes" class="md-nav__link">
      4. Y si los datos son enormes
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../../../5_interactuando_mapa/" title="5. Interactuando con el mapa" class="md-nav__link">
      5. Interactuando con el mapa
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../../../6_osm_y_tilemill/" title="6. Usando OpenStreetMap como fuente de datos, Tilemill. Enlace a GeoTalleres" class="md-nav__link">
      6. Usando OpenStreetMap como fuente de datos, Tilemill. Enlace a GeoTalleres
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../../../7_extra_1_osm_y_umap/" title="7. Extra 1. Un visor rápido con datos vectoriales de OSM usando uMap" class="md-nav__link">
      7. Extra 1. Un visor rápido con datos vectoriales de OSM usando uMap
    </a>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">Tabla de contenidos</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#table-of-contents" title="Table of Contents" class="md-nav__link">
    Table of Contents
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#protocol-support" title="Protocol support" class="md-nav__link">
    Protocol support
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#installing" title="Installing" class="md-nav__link">
    Installing
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#opt-in-for-performance-and-spec-compliance" title="Opt-in for performance and spec compliance" class="md-nav__link">
    Opt-in for performance and spec compliance
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#api-docs" title="API docs" class="md-nav__link">
    API docs
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#websocket-compression" title="WebSocket compression" class="md-nav__link">
    WebSocket compression
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#usage-examples" title="Usage examples" class="md-nav__link">
    Usage examples
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#sending-and-receiving-text-data" title="Sending and receiving text data" class="md-nav__link">
    Sending and receiving text data
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#sending-binary-data" title="Sending binary data" class="md-nav__link">
    Sending binary data
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#simple-server" title="Simple server" class="md-nav__link">
    Simple server
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#external-https-server" title="External HTTP/S server" class="md-nav__link">
    External HTTP/S server
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#multiple-servers-sharing-a-single-https-server" title="Multiple servers sharing a single HTTP/S server" class="md-nav__link">
    Multiple servers sharing a single HTTP/S server
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#server-broadcast" title="Server broadcast" class="md-nav__link">
    Server broadcast
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#echowebsocketorg-demo" title="echo.websocket.org demo" class="md-nav__link">
    echo.websocket.org demo
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#other-examples" title="Other examples" class="md-nav__link">
    Other examples
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#error-handling-best-practices" title="Error handling best practices" class="md-nav__link">
    Error handling best practices
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#faq" title="FAQ" class="md-nav__link">
    FAQ
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#how-to-get-the-ip-address-of-the-client" title="How to get the IP address of the client?" class="md-nav__link">
    How to get the IP address of the client?
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#how-to-detect-and-close-broken-connections" title="How to detect and close broken connections?" class="md-nav__link">
    How to detect and close broken connections?
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#how-to-connect-via-a-proxy" title="How to connect via a proxy?" class="md-nav__link">
    How to connect via a proxy?
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#changelog" title="Changelog" class="md-nav__link">
    Changelog
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#license" title="License" class="md-nav__link">
    License
  </a>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                  <a href="https://github.com/xeoinquedos/curso-webgis/edit/master/docs/openlayers/ol-googlemaps/node_modules/ws/README.md" title="Editar esta página" class="md-icon md-content__icon">&#xE3C9;</a>
                
                
                <h1 id="ws-a-nodejs-websocket-library">ws: a Node.js WebSocket library</h1>
<p><a href="https://www.npmjs.com/package/ws"><img alt="Version npm" src="https://img.shields.io/npm/v/ws.svg" /></a>
<a href="https://travis-ci.org/websockets/ws"><img alt="Linux Build" src="https://img.shields.io/travis/websockets/ws/master.svg" /></a>
<a href="https://ci.appveyor.com/project/lpinca/ws"><img alt="Windows Build" src="https://ci.appveyor.com/api/projects/status/github/websockets/ws?branch=master&amp;svg=true" /></a>
<a href="https://coveralls.io/r/websockets/ws?branch=master"><img alt="Coverage Status" src="https://img.shields.io/coveralls/websockets/ws/master.svg" /></a></p>
<p>ws is a simple to use, blazing fast, and thoroughly tested WebSocket client
and server implementation.</p>
<p>Passes the quite extensive Autobahn test suite: <a href="http://websockets.github.io/ws/autobahn/servers/">server</a>,
<a href="http://websockets.github.io/ws/autobahn/clients/">client</a>.</p>
<p><strong>Note</strong>: This module does not work in the browser. The client in the docs is a
reference to a back end with the role of a client in the WebSocket
communication. Browser clients must use the native
<a href="https://developer.mozilla.org/en-US/docs/Web/API/WebSocket"><code>WebSocket</code></a> object.
To make the same code work seamlessly on Node.js and the browser, you can use
one of the many wrappers available on npm, like
<a href="https://github.com/heineiuo/isomorphic-ws">isomorphic-ws</a>.</p>
<h2 id="table-of-contents">Table of Contents</h2>
<ul>
<li><a href="#protocol-support">Protocol support</a></li>
<li><a href="#installing">Installing</a></li>
<li><a href="#opt-in-for-performance-and-spec-compliance">Opt-in for performance and spec compliance</a></li>
<li><a href="#api-docs">API docs</a></li>
<li><a href="#websocket-compression">WebSocket compression</a></li>
<li><a href="#usage-examples">Usage examples</a></li>
<li><a href="#sending-and-receiving-text-data">Sending and receiving text data</a></li>
<li><a href="#sending-binary-data">Sending binary data</a></li>
<li><a href="#simple-server">Simple server</a></li>
<li><a href="#external-https-server">External HTTP/S server</a></li>
<li><a href="#multiple-servers-sharing-a-single-https-server">Multiple servers sharing a single HTTP/S server</a></li>
<li><a href="#server-broadcast">Server broadcast</a></li>
<li><a href="#echowebsocketorg-demo">echo.websocket.org demo</a></li>
<li><a href="#other-examples">Other examples</a></li>
<li><a href="#error-handling-best-practices">Error handling best practices</a></li>
<li><a href="#faq">FAQ</a></li>
<li><a href="#how-to-get-the-ip-address-of-the-client">How to get the IP address of the client?</a></li>
<li><a href="#how-to-detect-and-close-broken-connections">How to detect and close broken connections?</a></li>
<li><a href="#how-to-connect-via-a-proxy">How to connect via a proxy?</a></li>
<li><a href="#changelog">Changelog</a></li>
<li><a href="#license">License</a></li>
</ul>
<h2 id="protocol-support">Protocol support</h2>
<ul>
<li><strong>HyBi drafts 07-12</strong> (Use the option <code>protocolVersion: 8</code>)</li>
<li><strong>HyBi drafts 13-17</strong> (Current default, alternatively option <code>protocolVersion: 13</code>)</li>
</ul>
<h2 id="installing">Installing</h2>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="codehilite"><pre><span></span>npm install --save ws
</pre></div>
</td></tr></table>

<h3 id="opt-in-for-performance-and-spec-compliance">Opt-in for performance and spec compliance</h3>
<p>There are 2 optional modules that can be installed along side with the ws
module. These modules are binary addons which improve certain operations.
Prebuilt binaries are available for the most popular platforms so you don't
necessarily need to have a C++ compiler installed on your machine.</p>
<ul>
<li><code>npm install --save-optional bufferutil</code>: Allows to efficiently perform
  operations such as masking and unmasking the data payload of the WebSocket
  frames.</li>
<li><code>npm install --save-optional utf-8-validate</code>: Allows to efficiently check
  if a message contains valid UTF-8 as required by the spec.</li>
</ul>
<h2 id="api-docs">API docs</h2>
<p>See <a href="./doc/ws.md"><code>/doc/ws.md</code></a> for Node.js-like docs for the ws classes.</p>
<h2 id="websocket-compression">WebSocket compression</h2>
<p>ws supports the <a href="https://tools.ietf.org/html/rfc7692">permessage-deflate extension</a> which
enables the client and server to negotiate a compression algorithm and its
parameters, and then selectively apply it to the data payloads of each
WebSocket message.</p>
<p>The extension is disabled by default on the server and enabled by default on
the client. It adds a significant overhead in terms of performance and memory
consumption so we suggest to enable it only if it is really needed.</p>
<p>Note that Node.js has a variety of issues with high-performance compression,
where increased concurrency, especially on Linux, can lead to
<a href="https://github.com/nodejs/node/issues/8871">catastrophic memory fragmentation</a> and slow performance.
If you intend to use permessage-deflate in production, it is worthwhile to set
up a test representative of your workload and ensure Node.js/zlib will handle
it with acceptable performance and memory usage.</p>
<p>Tuning of permessage-deflate can be done via the options defined below. You can
also use <code>zlibDeflateOptions</code> and <code>zlibInflateOptions</code>, which is passed directly
into the creation of <a href="https://nodejs.org/api/zlib.html#zlib_zlib_createdeflateraw_options">raw deflate/inflate streams</a>.</p>
<p>See <a href="https://github.com/websockets/ws/blob/master/doc/ws.md#new-websocketserveroptions-callback">the docs</a> for more options.</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="kr">const</span> <span class="nx">WebSocket</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;ws&#39;</span><span class="p">);</span>

<span class="kr">const</span> <span class="nx">wss</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">WebSocket</span><span class="p">.</span><span class="nx">Server</span><span class="p">({</span>
  <span class="nx">port</span><span class="o">:</span> <span class="mi">8080</span><span class="p">,</span>
  <span class="nx">perMessageDeflate</span><span class="o">:</span> <span class="p">{</span>
    <span class="nx">zlibDeflateOptions</span><span class="o">:</span> <span class="p">{</span> <span class="c1">// See zlib defaults.</span>
      <span class="nx">chunkSize</span><span class="o">:</span> <span class="mi">1024</span><span class="p">,</span>
      <span class="nx">memLevel</span><span class="o">:</span> <span class="mi">7</span><span class="p">,</span>
      <span class="nx">level</span><span class="o">:</span> <span class="mi">3</span><span class="p">,</span>
    <span class="p">},</span>
    <span class="nx">zlibInflateOptions</span><span class="o">:</span> <span class="p">{</span>
      <span class="nx">chunkSize</span><span class="o">:</span> <span class="mi">10</span> <span class="o">*</span> <span class="mi">1024</span>
    <span class="p">},</span>
    <span class="c1">// Other options settable:</span>
    <span class="nx">clientNoContextTakeover</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span> <span class="c1">// Defaults to negotiated value.</span>
    <span class="nx">serverNoContextTakeover</span><span class="o">:</span> <span class="kc">true</span><span class="p">,</span> <span class="c1">// Defaults to negotiated value.</span>
    <span class="nx">clientMaxWindowBits</span><span class="o">:</span> <span class="mi">10</span><span class="p">,</span>       <span class="c1">// Defaults to negotiated value.</span>
    <span class="nx">serverMaxWindowBits</span><span class="o">:</span> <span class="mi">10</span><span class="p">,</span>       <span class="c1">// Defaults to negotiated value.</span>
    <span class="c1">// Below options specified as default values.</span>
    <span class="nx">concurrencyLimit</span><span class="o">:</span> <span class="mi">10</span><span class="p">,</span>          <span class="c1">// Limits zlib concurrency for perf.</span>
    <span class="nx">threshold</span><span class="o">:</span> <span class="mi">1024</span><span class="p">,</span>               <span class="c1">// Size (in bytes) below which messages</span>
                                   <span class="c1">// should not be compressed.</span>
  <span class="p">}</span>
<span class="p">});</span>
</pre></div>
</td></tr></table>

<p>The client will only use the extension if it is supported and enabled on the
server. To always disable the extension on the client set the
<code>perMessageDeflate</code> option to <code>false</code>.</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="kr">const</span> <span class="nx">WebSocket</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;ws&#39;</span><span class="p">);</span>

<span class="kr">const</span> <span class="nx">ws</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">WebSocket</span><span class="p">(</span><span class="s1">&#39;ws://www.host.com/path&#39;</span><span class="p">,</span> <span class="p">{</span>
  <span class="nx">perMessageDeflate</span><span class="o">:</span> <span class="kc">false</span>
<span class="p">});</span>
</pre></div>
</td></tr></table>

<h2 id="usage-examples">Usage examples</h2>
<h3 id="sending-and-receiving-text-data">Sending and receiving text data</h3>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="kr">const</span> <span class="nx">WebSocket</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;ws&#39;</span><span class="p">);</span>

<span class="kr">const</span> <span class="nx">ws</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">WebSocket</span><span class="p">(</span><span class="s1">&#39;ws://www.host.com/path&#39;</span><span class="p">);</span>

<span class="nx">ws</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;open&#39;</span><span class="p">,</span> <span class="kd">function</span> <span class="nx">open</span><span class="p">()</span> <span class="p">{</span>
  <span class="nx">ws</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="s1">&#39;something&#39;</span><span class="p">);</span>
<span class="p">});</span>

<span class="nx">ws</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;message&#39;</span><span class="p">,</span> <span class="kd">function</span> <span class="nx">incoming</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">data</span><span class="p">);</span>
<span class="p">});</span>
</pre></div>
</td></tr></table>

<h3 id="sending-binary-data">Sending binary data</h3>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="kr">const</span> <span class="nx">WebSocket</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;ws&#39;</span><span class="p">);</span>

<span class="kr">const</span> <span class="nx">ws</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">WebSocket</span><span class="p">(</span><span class="s1">&#39;ws://www.host.com/path&#39;</span><span class="p">);</span>

<span class="nx">ws</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;open&#39;</span><span class="p">,</span> <span class="kd">function</span> <span class="nx">open</span><span class="p">()</span> <span class="p">{</span>
  <span class="kr">const</span> <span class="nx">array</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Float32Array</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span>

  <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">array</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="o">++</span><span class="nx">i</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">array</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">=</span> <span class="nx">i</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="nx">ws</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="nx">array</span><span class="p">);</span>
<span class="p">});</span>
</pre></div>
</td></tr></table>

<h3 id="simple-server">Simple server</h3>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="kr">const</span> <span class="nx">WebSocket</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;ws&#39;</span><span class="p">);</span>

<span class="kr">const</span> <span class="nx">wss</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">WebSocket</span><span class="p">.</span><span class="nx">Server</span><span class="p">({</span> <span class="nx">port</span><span class="o">:</span> <span class="mi">8080</span> <span class="p">});</span>

<span class="nx">wss</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;connection&#39;</span><span class="p">,</span> <span class="kd">function</span> <span class="nx">connection</span><span class="p">(</span><span class="nx">ws</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">ws</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;message&#39;</span><span class="p">,</span> <span class="kd">function</span> <span class="nx">incoming</span><span class="p">(</span><span class="nx">message</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;received: %s&#39;</span><span class="p">,</span> <span class="nx">message</span><span class="p">);</span>
  <span class="p">});</span>

  <span class="nx">ws</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="s1">&#39;something&#39;</span><span class="p">);</span>
<span class="p">});</span>
</pre></div>
</td></tr></table>

<h3 id="external-https-server">External HTTP/S server</h3>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="kr">const</span> <span class="nx">fs</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;fs&#39;</span><span class="p">);</span>
<span class="kr">const</span> <span class="nx">https</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;https&#39;</span><span class="p">);</span>
<span class="kr">const</span> <span class="nx">WebSocket</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;ws&#39;</span><span class="p">);</span>

<span class="kr">const</span> <span class="nx">server</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">https</span><span class="p">.</span><span class="nx">createServer</span><span class="p">({</span>
  <span class="nx">cert</span><span class="o">:</span> <span class="nx">fs</span><span class="p">.</span><span class="nx">readFileSync</span><span class="p">(</span><span class="s1">&#39;/path/to/cert.pem&#39;</span><span class="p">),</span>
  <span class="nx">key</span><span class="o">:</span> <span class="nx">fs</span><span class="p">.</span><span class="nx">readFileSync</span><span class="p">(</span><span class="s1">&#39;/path/to/key.pem&#39;</span><span class="p">)</span>
<span class="p">});</span>
<span class="kr">const</span> <span class="nx">wss</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">WebSocket</span><span class="p">.</span><span class="nx">Server</span><span class="p">({</span> <span class="nx">server</span> <span class="p">});</span>

<span class="nx">wss</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;connection&#39;</span><span class="p">,</span> <span class="kd">function</span> <span class="nx">connection</span><span class="p">(</span><span class="nx">ws</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">ws</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;message&#39;</span><span class="p">,</span> <span class="kd">function</span> <span class="nx">incoming</span><span class="p">(</span><span class="nx">message</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;received: %s&#39;</span><span class="p">,</span> <span class="nx">message</span><span class="p">);</span>
  <span class="p">});</span>

  <span class="nx">ws</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="s1">&#39;something&#39;</span><span class="p">);</span>
<span class="p">});</span>

<span class="nx">server</span><span class="p">.</span><span class="nx">listen</span><span class="p">(</span><span class="mi">8080</span><span class="p">);</span>
</pre></div>
</td></tr></table>

<h3 id="multiple-servers-sharing-a-single-https-server">Multiple servers sharing a single HTTP/S server</h3>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="kr">const</span> <span class="nx">http</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;http&#39;</span><span class="p">);</span>
<span class="kr">const</span> <span class="nx">WebSocket</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;ws&#39;</span><span class="p">);</span>

<span class="kr">const</span> <span class="nx">server</span> <span class="o">=</span> <span class="nx">http</span><span class="p">.</span><span class="nx">createServer</span><span class="p">();</span>
<span class="kr">const</span> <span class="nx">wss1</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">WebSocket</span><span class="p">.</span><span class="nx">Server</span><span class="p">({</span> <span class="nx">noServer</span><span class="o">:</span> <span class="kc">true</span> <span class="p">});</span>
<span class="kr">const</span> <span class="nx">wss2</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">WebSocket</span><span class="p">.</span><span class="nx">Server</span><span class="p">({</span> <span class="nx">noServer</span><span class="o">:</span> <span class="kc">true</span> <span class="p">});</span>

<span class="nx">wss1</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;connection&#39;</span><span class="p">,</span> <span class="kd">function</span> <span class="nx">connection</span><span class="p">(</span><span class="nx">ws</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// ...</span>
<span class="p">});</span>

<span class="nx">wss2</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;connection&#39;</span><span class="p">,</span> <span class="kd">function</span> <span class="nx">connection</span><span class="p">(</span><span class="nx">ws</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// ...</span>
<span class="p">});</span>

<span class="nx">server</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;upgrade&#39;</span><span class="p">,</span> <span class="kd">function</span> <span class="nx">upgrade</span><span class="p">(</span><span class="nx">request</span><span class="p">,</span> <span class="nx">socket</span><span class="p">,</span> <span class="nx">head</span><span class="p">)</span> <span class="p">{</span>
  <span class="kr">const</span> <span class="nx">pathname</span> <span class="o">=</span> <span class="nx">url</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">request</span><span class="p">.</span><span class="nx">url</span><span class="p">).</span><span class="nx">pathname</span><span class="p">;</span>

  <span class="k">if</span> <span class="p">(</span><span class="nx">pathname</span> <span class="o">===</span> <span class="s1">&#39;/foo&#39;</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">wss1</span><span class="p">.</span><span class="nx">handleUpgrade</span><span class="p">(</span><span class="nx">request</span><span class="p">,</span> <span class="nx">socket</span><span class="p">,</span> <span class="nx">head</span><span class="p">,</span> <span class="kd">function</span> <span class="nx">done</span><span class="p">(</span><span class="nx">ws</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">wss1</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;connection&#39;</span><span class="p">,</span> <span class="nx">ws</span><span class="p">,</span> <span class="nx">request</span><span class="p">);</span>
    <span class="p">});</span>
  <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">pathname</span> <span class="o">===</span> <span class="s1">&#39;/bar&#39;</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">wss2</span><span class="p">.</span><span class="nx">handleUpgrade</span><span class="p">(</span><span class="nx">request</span><span class="p">,</span> <span class="nx">socket</span><span class="p">,</span> <span class="nx">head</span><span class="p">,</span> <span class="kd">function</span> <span class="nx">done</span><span class="p">(</span><span class="nx">ws</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">wss2</span><span class="p">.</span><span class="nx">emit</span><span class="p">(</span><span class="s1">&#39;connection&#39;</span><span class="p">,</span> <span class="nx">ws</span><span class="p">,</span> <span class="nx">request</span><span class="p">);</span>
    <span class="p">});</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="nx">socket</span><span class="p">.</span><span class="nx">destroy</span><span class="p">();</span>
  <span class="p">}</span>
<span class="p">});</span>

<span class="nx">server</span><span class="p">.</span><span class="nx">listen</span><span class="p">(</span><span class="mi">8080</span><span class="p">);</span>
</pre></div>
</td></tr></table>

<h3 id="server-broadcast">Server broadcast</h3>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="kr">const</span> <span class="nx">WebSocket</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;ws&#39;</span><span class="p">);</span>

<span class="kr">const</span> <span class="nx">wss</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">WebSocket</span><span class="p">.</span><span class="nx">Server</span><span class="p">({</span> <span class="nx">port</span><span class="o">:</span> <span class="mi">8080</span> <span class="p">});</span>

<span class="c1">// Broadcast to all.</span>
<span class="nx">wss</span><span class="p">.</span><span class="nx">broadcast</span> <span class="o">=</span> <span class="kd">function</span> <span class="nx">broadcast</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">wss</span><span class="p">.</span><span class="nx">clients</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="kd">function</span> <span class="nx">each</span><span class="p">(</span><span class="nx">client</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">client</span><span class="p">.</span><span class="nx">readyState</span> <span class="o">===</span> <span class="nx">WebSocket</span><span class="p">.</span><span class="nx">OPEN</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">client</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="nx">data</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">});</span>
<span class="p">};</span>

<span class="nx">wss</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;connection&#39;</span><span class="p">,</span> <span class="kd">function</span> <span class="nx">connection</span><span class="p">(</span><span class="nx">ws</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">ws</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;message&#39;</span><span class="p">,</span> <span class="kd">function</span> <span class="nx">incoming</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// Broadcast to everyone else.</span>
    <span class="nx">wss</span><span class="p">.</span><span class="nx">clients</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="kd">function</span> <span class="nx">each</span><span class="p">(</span><span class="nx">client</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">client</span> <span class="o">!==</span> <span class="nx">ws</span> <span class="o">&amp;&amp;</span> <span class="nx">client</span><span class="p">.</span><span class="nx">readyState</span> <span class="o">===</span> <span class="nx">WebSocket</span><span class="p">.</span><span class="nx">OPEN</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">client</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="nx">data</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="p">});</span>
  <span class="p">});</span>
<span class="p">});</span>
</pre></div>
</td></tr></table>

<h3 id="echowebsocketorg-demo">echo.websocket.org demo</h3>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="kr">const</span> <span class="nx">WebSocket</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;ws&#39;</span><span class="p">);</span>

<span class="kr">const</span> <span class="nx">ws</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">WebSocket</span><span class="p">(</span><span class="s1">&#39;wss://echo.websocket.org/&#39;</span><span class="p">,</span> <span class="p">{</span>
  <span class="nx">origin</span><span class="o">:</span> <span class="s1">&#39;https://websocket.org&#39;</span>
<span class="p">});</span>

<span class="nx">ws</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;open&#39;</span><span class="p">,</span> <span class="kd">function</span> <span class="nx">open</span><span class="p">()</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;connected&#39;</span><span class="p">);</span>
  <span class="nx">ws</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="nb">Date</span><span class="p">.</span><span class="nx">now</span><span class="p">());</span>
<span class="p">});</span>

<span class="nx">ws</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;close&#39;</span><span class="p">,</span> <span class="kd">function</span> <span class="nx">close</span><span class="p">()</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;disconnected&#39;</span><span class="p">);</span>
<span class="p">});</span>

<span class="nx">ws</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;message&#39;</span><span class="p">,</span> <span class="kd">function</span> <span class="nx">incoming</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`Roundtrip time: </span><span class="si">${</span><span class="nb">Date</span><span class="p">.</span><span class="nx">now</span><span class="p">()</span> <span class="o">-</span> <span class="nx">data</span><span class="si">}</span><span class="sb"> ms`</span><span class="p">);</span>

  <span class="nx">setTimeout</span><span class="p">(</span><span class="kd">function</span> <span class="nx">timeout</span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">ws</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="nb">Date</span><span class="p">.</span><span class="nx">now</span><span class="p">());</span>
  <span class="p">},</span> <span class="mi">500</span><span class="p">);</span>
<span class="p">});</span>
</pre></div>
</td></tr></table>

<h3 id="other-examples">Other examples</h3>
<p>For a full example with a browser client communicating with a ws server, see the
examples folder.</p>
<p>Otherwise, see the test cases.</p>
<h2 id="error-handling-best-practices">Error handling best practices</h2>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="c1">// If the WebSocket is closed before the following send is attempted</span>
<span class="nx">ws</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="s1">&#39;something&#39;</span><span class="p">);</span>

<span class="c1">// Errors (both immediate and async write errors) can be detected in an optional</span>
<span class="c1">// callback. The callback is also the only way of being notified that data has</span>
<span class="c1">// actually been sent.</span>
<span class="nx">ws</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="s1">&#39;something&#39;</span><span class="p">,</span> <span class="kd">function</span> <span class="nx">ack</span><span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// If error is not defined, the send has been completed, otherwise the error</span>
  <span class="c1">// object will indicate what failed.</span>
<span class="p">});</span>

<span class="c1">// Immediate errors can also be handled with `try...catch`, but **note** that</span>
<span class="c1">// since sends are inherently asynchronous, socket write failures will *not* be</span>
<span class="c1">// captured when this technique is used.</span>
<span class="k">try</span> <span class="p">{</span> <span class="nx">ws</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="s1">&#39;something&#39;</span><span class="p">);</span> <span class="p">}</span>
<span class="k">catch</span> <span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* handle error */</span> <span class="p">}</span>
</pre></div>
</td></tr></table>

<h2 id="faq">FAQ</h2>
<h3 id="how-to-get-the-ip-address-of-the-client">How to get the IP address of the client?</h3>
<p>The remote IP address can be obtained from the raw socket.</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="kr">const</span> <span class="nx">WebSocket</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;ws&#39;</span><span class="p">);</span>

<span class="kr">const</span> <span class="nx">wss</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">WebSocket</span><span class="p">.</span><span class="nx">Server</span><span class="p">({</span> <span class="nx">port</span><span class="o">:</span> <span class="mi">8080</span> <span class="p">});</span>

<span class="nx">wss</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;connection&#39;</span><span class="p">,</span> <span class="kd">function</span> <span class="nx">connection</span><span class="p">(</span><span class="nx">ws</span><span class="p">,</span> <span class="nx">req</span><span class="p">)</span> <span class="p">{</span>
  <span class="kr">const</span> <span class="nx">ip</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">connection</span><span class="p">.</span><span class="nx">remoteAddress</span><span class="p">;</span>
<span class="p">});</span>
</pre></div>
</td></tr></table>

<p>When the server runs behind a proxy like NGINX, the de-facto standard is to use
the <code>X-Forwarded-For</code> header.</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="nx">wss</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;connection&#39;</span><span class="p">,</span> <span class="kd">function</span> <span class="nx">connection</span><span class="p">(</span><span class="nx">ws</span><span class="p">,</span> <span class="nx">req</span><span class="p">)</span> <span class="p">{</span>
  <span class="kr">const</span> <span class="nx">ip</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">headers</span><span class="p">[</span><span class="s1">&#39;x-forwarded-for&#39;</span><span class="p">].</span><span class="nx">split</span><span class="p">(</span><span class="sr">/\s*,\s*/</span><span class="p">)[</span><span class="mi">0</span><span class="p">];</span>
<span class="p">});</span>
</pre></div>
</td></tr></table>

<h3 id="how-to-detect-and-close-broken-connections">How to detect and close broken connections?</h3>
<p>Sometimes the link between the server and the client can be interrupted in a
way that keeps both the server and the client unaware of the broken state of the
connection (e.g. when pulling the cord).</p>
<p>In these cases ping messages can be used as a means to verify that the remote
endpoint is still responsive.</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="kr">const</span> <span class="nx">WebSocket</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;ws&#39;</span><span class="p">);</span>

<span class="kr">const</span> <span class="nx">wss</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">WebSocket</span><span class="p">.</span><span class="nx">Server</span><span class="p">({</span> <span class="nx">port</span><span class="o">:</span> <span class="mi">8080</span> <span class="p">});</span>

<span class="kd">function</span> <span class="nx">noop</span><span class="p">()</span> <span class="p">{}</span>

<span class="kd">function</span> <span class="nx">heartbeat</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">isAlive</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="nx">wss</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;connection&#39;</span><span class="p">,</span> <span class="kd">function</span> <span class="nx">connection</span><span class="p">(</span><span class="nx">ws</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">ws</span><span class="p">.</span><span class="nx">isAlive</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
  <span class="nx">ws</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;pong&#39;</span><span class="p">,</span> <span class="nx">heartbeat</span><span class="p">);</span>
<span class="p">});</span>

<span class="kr">const</span> <span class="nx">interval</span> <span class="o">=</span> <span class="nx">setInterval</span><span class="p">(</span><span class="kd">function</span> <span class="nx">ping</span><span class="p">()</span> <span class="p">{</span>
  <span class="nx">wss</span><span class="p">.</span><span class="nx">clients</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="kd">function</span> <span class="nx">each</span><span class="p">(</span><span class="nx">ws</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">ws</span><span class="p">.</span><span class="nx">isAlive</span> <span class="o">===</span> <span class="kc">false</span><span class="p">)</span> <span class="k">return</span> <span class="nx">ws</span><span class="p">.</span><span class="nx">terminate</span><span class="p">();</span>

    <span class="nx">ws</span><span class="p">.</span><span class="nx">isAlive</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
    <span class="nx">ws</span><span class="p">.</span><span class="nx">ping</span><span class="p">(</span><span class="nx">noop</span><span class="p">);</span>
  <span class="p">});</span>
<span class="p">},</span> <span class="mi">30000</span><span class="p">);</span>
</pre></div>
</td></tr></table>

<p>Pong messages are automatically sent in response to ping messages as required
by the spec.</p>
<h3 id="how-to-connect-via-a-proxy">How to connect via a proxy?</h3>
<p>Use a custom <code>http.Agent</code> implementation like <a href="https://github.com/TooTallNate/node-https-proxy-agent">https-proxy-agent</a> or
<a href="https://github.com/TooTallNate/node-socks-proxy-agent">socks-proxy-agent</a>.</p>
<h2 id="changelog">Changelog</h2>
<p>We're using the GitHub <a href="https://github.com/websockets/ws/releases">releases</a> for changelog entries.</p>
<h2 id="license">License</h2>
<p><a href="LICENSE">MIT</a></p>
                
                  
                
              
              
                


              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
        powered by
        <a href="https://www.mkdocs.org">MkDocs</a>
        and
        <a href="https://squidfunk.github.io/mkdocs-material/">
          Material for MkDocs</a>
      </div>
      
        
      
    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../../../../assets/javascripts/application.583bbe55.js"></script>
      
        
        
          
          <script src="../../../../assets/javascripts/lunr/lunr.stemmer.support.js"></script>
          
            
              
              
                <script src="../../../../assets/javascripts/lunr/lunr.es.js"></script>
              
            
          
          
        
      
      <script>app.initialize({version:"1.0.4",url:{base:"../../../.."}})</script>
      
    
    
      
    
  </body>
</html>